# Update Log

- 2025-10-01: Unified Google Workspace scope handling across agent creation and the OAuth endpoints. `/api/v1/auth/google/auth` now accepts an optional `tools` payload so the dashboard's authorize button can reuse the auth_url returned by the agents API. Shared helper methods in `AuthService` provide consistent scope lists for Gmail, Sheets, Calendar, Docs, and Drive, and the agent creation endpoint reuses them to decide when to surface the auth URL. Extended the API tests to cover tool-specific OAuth requests.
- 2025-10-01: Extended `/api/v1/agents/{id}` to surface `auth_required`, `auth_url`, and `auth_state` the same way agent creation does. The dashboard can now refresh an agent row and still get a fresh Google OAuth link for the Authorize button. Added regression coverage to ensure Google-aware agents always return an auth URL when scopes are missing.
- 2025-10-01: Updated the dashboard agent list to request fresh auth URLs on demand and renamed the Connect control to "Authorize". Clicking the button now opens the authentication popup with the latest OAuth link supplied by `GET /api/v1/agents/{id}`, ensuring the dashboard follows the API flow even after the initial creation response. The API now revokes stale Google tokens before issuing new auth URLs so scope upgrades (e.g., adding Sheets or Drive later) succeed without manual cleanup.
- 2025-10-01: Reworked `/api/v1/auth/google/auth` to mirror the agent-creation flow. The endpoint now accepts tool lists, revokes stale Google tokens when scopes expand, and returns `auth_required` metadata so callers know whether a new OAuth round-trip is necessary. `/api/v1/auth/google/callback` continues to honour state payload scopes, enabling dashboard-triggered authentication without creating an agent first.
- 2025-10-01: Hardened Google OAuth callback—when Google returns a union of previously granted scopes and the requested set, the API now loops through the provider’s expanded scope lists until the exchange succeeds or convergence fails, preventing the "Scope has changed" error from surfacing. Added service-level regression coverage to confirm the fallback.
- 2025-10-01: Updated the dashboard Google auth popup so the "Authenticate with Google" control is a direct hyperlink to the `auth_url` returned by the agents API. This avoids extra endpoint calls and always mirrors the link issued during agent creation.
- 2025-10-01: Dashboard HTTP client now respects the configured `VITE_API_BASE_URL` and otherwise falls back to the current window origin instead of hard-coding `http://localhost:8000`, ensuring dev tunnel URLs (e.g., `https://lfzlwlbz-8000.asse.devtunnels.ms`) work out of the box.
- 2025-10-01: Hardened dashboard agent fetching—`listAgents` now accepts either a bare array or `{agents: [...]}` payloads, defaulting to an empty list so the UI never crashes if the API shape varies.
- 2025-10-01: Fixed Google OAuth scope mismatch errors by implementing automatic authentication revocation and retry flow. When users create agents with different Google tools that require additional scopes, the dashboard now automatically revokes existing authentication and initiates a fresh OAuth flow with the required scopes. Added `handleScopeMismatchRetry` function that detects scope conflicts, revokes current auth tokens, and requests new authentication URLs with the proper scopes.
- 2025-10-01: Enhanced dashboard authentication flow for Google Workspace tools with intelligent scope mismatch detection and resolution. Improved error handling to properly detect "Scope has changed" errors and automatically trigger re-authentication flow. Added scope mismatch flag to AuthPopup component with specialized messaging for re-authentication scenarios.
- 2025-10-01: Fixed dashboard authentication flow for Google Workspace tools. Improved error handling to properly detect and handle scope mismatch errors. Added automatic retry logic when scope conflicts occur. Enhanced AuthPopup with better instructions and fallback mechanisms. Simplified authentication state management to prevent race conditions.
- 2025-10-01: Enhanced dashboard authentication flow with retry mechanism. Added pending agent payload storage to allow users to retry agent creation after completing Google OAuth authentication. Implemented retry button in AuthPopup component with improved user instructions. Fixed authentication state management to preserve create form context during authentication flow.
- 2025-10-01: Systematically tested and verified complete API flow from registration to agent creation following documentation specifications. Confirmed dashboard correctly implements all documented endpoints including query parameter authentication and proper JSON payload handling for agent creation.
- 2025-10-01: Fixed Google Workspace authentication flow in dashboard when creating agents with Google tools. The dashboard now properly detects when authentication is required and shows the AuthPopup with the correct auth_url from the API response. The API endpoint correctly returns auth_required, auth_url, and auth_state when Google tools are selected, and the dashboard handles this by showing a popup with an "Authenticate with Google" button that opens the OAuth flow in a new window.
- 2025-10-01: Fixed documentation in how-to-use.md to use tool names instead of tool IDs. The API expects tool names (e.g., "gmail", "google_sheets", "google_calendar") rather than tool IDs. Added a new tools section documenting all available built-in tools with their names and descriptions.
- 2025-09-29: Updated LangGraph tool wrapper to accept either a single JSON string or direct keyword arguments, preventing `_ToolInput` validation errors when the agent omits the `input` key.
- 2025-09-29: Normalised Gmail draft action routing so requests honoring `action=create_draft` always call the draft API instead of sending immediately; added extra execution logging for returned LangGraph messages.
- 2025-09-29: Added Google Calendar built-in tool (list/create/get events), wired it into tool service, prompts, and documentation.
- 2025-09-29: Fixed agent-tool insertion to serialize config payloads as JSON when using raw SQL, preventing PostgreSQL "can't adapt type dict" errors during agent creation.
- 2025-09-29: Corrected raw SQL insert to cast JSON payloads with `CAST(:config AS jsonb)`, eliminating PostgreSQL syntax errors during agent creation.
- 2025-09-29: Hardened tool wrapper to treat empty strings as `{}` and return clear guidance when no JSON payload is supplied, avoiding repeated "Invalid JSON input" errors for Google Calendar tool calls.
- 2025-09-29: Added key-value fallback parsing for tool invocations so natural language strings like `action=list_events` are converted to JSON payloads before execution.
- 2025-09-29: Ensured Google Calendar tool uses authenticated execution path and maps common shorthand phrases (`"list events"`, etc.) to structured payloads, plus added calendar scopes to the OAuth requirements.
- 2025-09-29: Updated Google Calendar event time handling to accept pre-structured dict payloads (with `dateTime`/`date` fields) to avoid `'dict' object has no attribute 'strip'` errors during event creation.
- 2025-09-29: Added attendee normalisation helper to Google Calendar tool so list/tuple/string inputs are accepted when creating events.
- 2025-09-29: Added attendee email validation in Google Calendar tool to surface clear errors before hitting the Calendar API when emails are malformed.
- 2025-09-29: Imported the `re` module for Google Calendar email validation to resolve `name 're' is not defined` errors during event creation.
- 2025-09-29: Added document ingestion endpoint (`POST /api/v1/agents/{id}/documents`) that converts pdf/docx/pptx/txt to cleaned text, chunks it, embeds with OpenAI, and stores vectors in the `embeddings` table; includes new `EmbeddingService` and dependency wiring.
- 2025-09-29: Document ingestion now accepts optional `chunk_size`, `chunk_overlap`, and `batch_size` form fields and embeds data in token-safe batches to avoid OpenAI 300k token limits.
- 2025-09-29: Introduced RAG support—ExecutionService now retrieves top 3 similar embeddings per query and appends them to the system prompt context before running the agent.
- 2025-09-29: Added console log format option (`LOG_FORMAT=console`) rendering agent logs in a human-readable layout (default remains JSON).
- 2025-09-29: Instrumented RAG flow logging—each retrieval now logs start/end, per-match metadata, and preview content so terminal output shows the full agent RAG process.
- 2025-09-29: Improved RAG log formatting with bracketed headers and indented key/value pairs for easier terminal readability.
- 2025-09-29: Fixed RAG logging to avoid Structlog argument conflicts by passing `event` as a keyword-only argument and separating message text from structured fields.
- 2025-09-29: Added persistent API keys for users—`users.api_key` column with migration, schema updates, and unique constraint so API keys are stored in the database.
- 2025-09-29: Added automatic chunk-size downsizing for large documents; ingestion now logs adjustments and keeps character counts to prevent oversized embedding requests.
- 2025-09-29: Added project-wide `.gitignore` covering Python artifacts, editor files, secrets, and generated data.
